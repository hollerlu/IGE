---
title: "IGE and Off-campus study"
output:
  html_document:
    df_print: paged
runtime: shiny
---

```{r Data, echo=FALSE}
# The code here prevents messages from popping up in the Shiny app
library(shiny)
suppressWarnings(suppressMessages(library(dplyr)))
suppressWarnings(suppressMessages(library(leaflet)))
suppressWarnings(suppressMessages(library(maps)))
suppressWarnings(suppressMessages(library(sf)))
library(RColorBrewer)

# Note 1: make variable names in format: first word lowercase, other words uppercase
# Example: firstVariable, secondVariable, yetAnotherVariable

# Note 2: This code chunk modifies the data, and maybe does other code


# Change the file location once I figure out what it's supposed to be
dataFile <- read.csv("OCS Data 3-7.csv")


# Changed column names, but just changed punctuation
# HOWEVER, ProgramCountry was changed to NAME
colnames(dataFile) <- c("ApplicationCycle", "Ethnicity", "AnticipatedCompletionDate", "ProgramName", "NAME", "ProgramCity", "ProgramRegion", "ApplicationID", "ProgramYear", "ProgramTerm", "ApplicationStatusAlias", "Gender", "PreferredGender")


# Replaced "Non-resident alien" with "International student"
dataFile$Ethnicity <- ifelse(dataFile$Ethnicity == "Non-resident alien", "International student", dataFile$Ethnicity)


# Create a dataframe of countries and the number of students who have visited them
countryCounts <- dataFile %>%
  group_by(NAME) %>%
  summarise(TripCount = n(), ProgramNames = list(ProgramName))
```

```{r Code, echo=FALSE, eval=FALSE}

# Note 1: Making the table show with the Shiny at the same time doesn't work. You have to
# comment out runtime:shiny from the header and comment out the shiny functions to show the 
# table. I should figure out a better way of doing this.

# Note 2: This code chunk is good for looking at the data. Set eval=FALSE in the header when
# you want this code not to run.


# Includes years as well as semesters
unique(dataFile$ApplicationCycle)


# Has blank values, "Non-resident alien" has been replaced
unique(dataFile$Ethnicity)


# Has blank values
unique(dataFile$AnticipatedCompletionDate)


# "X - ", "x - " and "X-" are individual programs (ask about program abbreviations, i.e. IES)
# Fix "*<B>Grinnell-in-London</B>"
unique(dataFile$ProgramName)


# Nothing to say, maybe ask if there are any issues?
unique(dataFile$NAME)


# Includes "undefined", and U.S. cities include states
unique(dataFile$ProgramCity)


# Some regions overlap
unique(dataFile$ProgramRegion)


# I think these aren't all unique numbers? 1353/1639
unique(dataFile$ApplicationID)


# Just years, nothing to say
unique(dataFile$ProgramYear)


# "Academic Year", "Fall", and "Spring"
unique(dataFile$ProgramTerm)


# "Approved" and "Intend to Participate"
unique(dataFile$ApplicationStatusAlias)


# "M" and "F"
unique(dataFile$Gender)


# Only value is "NA"
unique(dataFile$PreferredGender)


```

```{r App, echo=FALSE}
server <- function(input, output) {

  # Reading in the country information
  worldMap <- read_sf("ne_50m_admin_0_countries.shp")


  # Putting the TripCounts into worldMap. I changed the name of ProgramCountry
  # to NAME to make the merge command work easier. That is dumb and I should probably
  # fix it at some point.
  worldMap <- merge(worldMap, countryCounts, by = 'NAME', all.x = TRUE)

  # Set all other countries to 0 trips
  worldMap$TripCount <- replace(worldMap$TripCount, is.na(worldMap$TripCount), 0)



  # The merging gets rid of:
  # Czech Republic 58
  # French Polynesia 1
  # Turks and Caicos Islands 6
  # U.S. Virgin Islands 2
  # United States 78
  
  # Due to using different spellings for the country names:
  # Czechia
  # Fr. Polynesia
  # Turks and Caicos Is.
  # U.S. Virgin Is.
  # United States of America
  
  # Also, the programs are lost, but I haven't figured out how to
  # add them back in since I don't wanna do it manually.


  # Manually adding in the values for these countries
  worldMap <- worldMap %>%  mutate(TripCount = ifelse(NAME == "Czechia", 58, TripCount))
  worldMap <- worldMap %>%  mutate(TripCount = ifelse(NAME == "Fr. Polynesia", 1, TripCount))
  worldMap <- worldMap %>%  mutate(TripCount = ifelse(NAME == "Turks and Caicos Is.", 6, TripCount))
  worldMap <- worldMap %>%  mutate(TripCount = ifelse(NAME == "U.S. Virgin Is.", 2, TripCount))
  worldMap <- worldMap %>%  mutate(TripCount = ifelse(NAME == "United States of America", 78, TripCount))



  # Creating a color palette for the map
  paletteNum <- colorNumeric("Reds", domain = worldMap$TripCount)


  # I'm not quite sure how this works, but it's the text that's displayed
  # whenever you hover over a country. The iterative code is so that the
  # programs appear as a list and not all in one row.
  hoverText <- lapply(seq(nrow(worldMap)), function(i) {
  unique_programs <- unique(worldMap$ProgramNames[[i]])
  paste(
    "Country: ", worldMap$NAME[i], "<br/>",
    "Visits: ", worldMap$TripCount[i], "<br/>",
    "Programs: ", paste(unique_programs, collapse = "<br/>"),
    sep = ""
  )
}) %>%
lapply(htmltools::HTML)


  # Creating the map
  output$map <- renderLeaflet({
    # Sets how far you can zoom so you don't go past the borders
    leaflet(options = leafletOptions(minZoom = 2)) %>%
      # Sets the map
      addProviderTiles("CartoDB.Voyager") %>%
      # Sets the starting viewpoint
      setView(lng = 0, lat = 30, zoom = 2) %>%
      # Sets the limits of scrolling
      setMaxBounds(lng1 = -180, lat1 = -90, lng2 = 180, lat2 = 90) %>%
      # Adds the actual chloropleth map for each country based on how many visits
      addPolygons(data = worldMap, fillColor = ~paletteNum(worldMap$TripCount), weight = 1,
                  color = 'black', smoothFactor = .3, fillOpacity = .75,
                  label = hoverText,
                  labelOptions = labelOptions(
                    style = list("font-weight" = "normal", padding = "3px 8px"),
                    textsize = "13px",
                    direction = "auto"
                  )
      ) %>%
      # Adds a legend
      addLegend(pal = paletteNum, values = worldMap$TripCount,
                title = '<small>Number of students<br>who have visited</small>',
                position = 'bottomleft')
  })


}

# UI
ui <- fluidPage(
  titlePanel("Student Travel Map"),
  leafletOutput("map")

)

# Note: if you get a scrollbar in the middle of the page, increase the height or width
shinyApp(ui = ui, server = server, options = list(width = 1000, height = 500))

```